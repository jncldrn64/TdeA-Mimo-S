<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrito de Compras | Helados Mimo's</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- CSS Custom de Mimo's -->
  <link rel="stylesheet" th:href="@{/css/mimos-style.css}">

  <!-- Estilos para placeholders más claros -->
  <style>
    ::placeholder {
      color: #999 !important;
      opacity: 0.6 !important;
    }
    input::placeholder {
      color: #999 !important;
      opacity: 0.6 !important;
    }
  </style>
</head>
<body>
  <div class="contenedor-central">
    <!-- HEADER -->
    <header>
      <a th:href="@{/catalogo}">
        <!-- NOTA: Logo Mimo's -->
        <img th:src="@{/img/logo-mimos.png}" alt="Logo Mimo's" id="logo" src="https://via.placeholder.com/150x100?text=LOGO+MIMOS">
      </a>
      <div id="barra-superior">
        <a href="#">
          <img th:src="@{/img/soporte-icon.svg}" alt="Soporte" src="https://via.placeholder.com/32?text=S">
          <span>Soporte</span>
        </a>
        <a th:href="@{/catalogo}">
          <img th:src="@{/img/catalogo-icon.svg}" alt="Catálogo" src="https://via.placeholder.com/32?text=C">
          <span>Catálogo</span>
        </a>
        <a th:href="@{/datos-envio}">
          <img th:src="@{/img/envio-icon.svg}" alt="Datos de Envío" src="https://via.placeholder.com/32?text=E">
          <span>Datos de Envío</span>
        </a>
      </div>
    </header>

    <!-- CONTENIDO PRINCIPAL: CARRITO -->
    <div class="contenido-carrito">
      
      <!-- Título -->
      <h1 class="titulo-carrito">Carrito de Compras</h1>

      <!-- Advertencias (stock insuficiente, productos desactivados, etc.) -->
      <div th:if="${advertencias != null && !advertencias.isEmpty()}" class="alertas-carrito">
        <div class="alert alert-warning alert-custom" role="alert">
          <strong>⚠️ Atención:</strong>
          <ul class="mb-0">
            <li th:each="advertencia : ${advertencias}" th:text="${advertencia}">Advertencia</li>
          </ul>
        </div>
      </div>

      <!-- Mensaje si el carrito está vacío -->
      <div th:if="${items == null || items.isEmpty()}" class="carrito-vacio">
        <div class="alert alert-info alert-custom text-center" role="alert">
          <h3>Tu carrito está vacío</h3>
          <p>Agrega productos desde el catálogo para comenzar tu compra</p>
          <a th:href="@{/catalogo}" class="btn btn-primary btn-mimo">Ir al Catálogo</a>
        </div>
      </div>

      <!-- LAYOUT: Items + Resumen (dos columnas) -->
      <div th:if="${items != null && !items.isEmpty()}" class="carrito-layout">
        
        <!-- COLUMNA IZQUIERDA: Items del Carrito -->
        <div class="carrito-items">
          
          <!-- Loop: Cada item del carrito -->
          <div th:each="item : ${items}" class="item-card" th:id="'item-' + ${item.idProducto}">
            
            <!-- Imagen del producto -->
            <div class="item-imagen">
              <!-- 
                NOTA: La imagen viene de item.producto.urlImagen
                Ejemplo: /img/productos/helado-vainilla.jpg
              -->
              <img 
                th:src="${item.producto.urlImagen}" 
                th:alt="${item.producto.nombreProducto}"
                src="https://via.placeholder.com/120?text=Producto"
                class="img-item">
            </div>

            <!-- Información del producto -->
            <div class="item-info">
              <h4 class="item-nombre" th:text="${item.producto.nombreProducto}">Copa Tentación</h4>
              <p class="item-precio-unitario">
                Precio unitario: <span th:text="'$' + ${#numbers.formatDecimal(item.precioUnitario, 1, 'POINT', 0, 'COMMA')}">$23,800</span>
              </p>
            </div>

            <!-- Controles de cantidad -->
            <div class="item-cantidad">
              <label class="form-label">Cantidad:</label>
              <div class="cantidad-controles">
                <!-- Botón Decrementar (AJAX) -->
                <button
                  class="btn btn-cantidad btn-decrementar"
                  th:data-producto-id="${item.idProducto}"
                  onclick="cambiarCantidad(this.getAttribute('data-producto-id'), -1)"
                  th:disabled="${item.cantidad <= 1}">
                  −
                </button>

                <!-- Input de cantidad (readonly, se actualiza con JS) -->
                <input
                  type="number"
                  class="form-control input-cantidad"
                  th:id="'cantidad-' + ${item.idProducto}"
                  th:value="${item.cantidad}"
                  readonly>

                <!-- Botón Incrementar (AJAX) -->
                <button
                  class="btn btn-cantidad btn-incrementar"
                  th:data-producto-id="${item.idProducto}"
                  onclick="cambiarCantidad(this.getAttribute('data-producto-id'), 1)">
                  +
                </button>
              </div>
            </div>

            <!-- Subtotal del item -->
            <div class="item-subtotal">
              <p class="texto-subtotal">Subtotal:</p>
              <p class="precio-subtotal" th:id="'subtotal-' + ${item.idProducto}">
                <span th:text="'$' + ${#numbers.formatDecimal(item.subtotal, 1, 'POINT', 0, 'COMMA')}">$47,600</span>
              </p>
            </div>

            <!-- Botones de acción -->
            <div class="item-acciones">
              <!-- Botón Eliminar (AJAX) -->
              <button 
                class="btn btn-eliminar" 
                th:onclick="'eliminarItem(' + ${item.idProducto} + ')'">
                Eliminar
              </button>
            </div>

          </div>
          <!-- Fin del loop -->

          <!-- Botón Vaciar Carrito -->
          <div class="acciones-globales">
            <button class="btn btn-vaciar" onclick="vaciarCarrito()">
              Vaciar Carrito
            </button>
          </div>

        </div>

        <!-- COLUMNA DERECHA: Resumen de Compra -->
        <div class="resumen-compra">
          <h3 class="titulo-resumen">Resumen de la compra</h3>

          <div class="resumen-detalle">
            <!-- Producto -->
            <div class="linea-resumen">
              <span class="label-resumen">Producto:</span>
              <span class="valor-resumen" id="resumen-producto">
                $<span th:text="${#numbers.formatDecimal(subtotal, 1, 'POINT', 0, 'COMMA')}">59,500.00</span>
              </span>
            </div>

            <!-- Envío -->
            <div class="linea-resumen">
              <span class="label-resumen">Envío:</span>
              <span class="valor-resumen" id="resumen-envio">
                <span th:if="${costoEnvio != null && costoEnvio > 0}">
                  $<span th:text="${#numbers.formatDecimal(costoEnvio, 1, 'POINT', 0, 'COMMA')}">5,000.00</span>
                </span>
                <span th:if="${costoEnvio == null || costoEnvio == 0}" class="text-muted" style="font-size: 0.85rem;">
                  A calcular
                </span>
              </span>
            </div>
            <!-- Nota sobre datos de envío -->
            <div th:if="${costoEnvio == null || costoEnvio == 0}" class="linea-resumen">
              <small class="text-muted" style="font-size: 0.8rem;">
                <a th:href="@{/datos-envio}" style="text-decoration: underline;">Complete sus datos de envío</a> para calcular el costo
              </small>
            </div>
            <!-- Link para editar datos de envío si ya están completos -->
            <div th:if="${costoEnvio != null && costoEnvio > 0}" class="linea-resumen">
              <small>
                <a th:href="@{/datos-envio}" style="text-decoration: underline; font-size: 0.85rem;">Editar datos de envío</a>
              </small>
            </div>

            <!-- IVA (19%) -->
            <div class="linea-resumen">
              <span class="label-resumen">IVA:</span>
              <span class="valor-resumen" id="resumen-iva">
                $<span th:text="${#numbers.formatDecimal(iva, 1, 'POINT', 0, 'COMMA')}">11,305.00</span>
              </span>
            </div>

            <!-- Descuento -->
            <div class="linea-resumen">
              <span class="label-resumen">Descuento:</span>
              <span class="valor-resumen" id="resumen-descuento">
                $<span th:text="${#numbers.formatDecimal(descuento, 1, 'POINT', 0, 'COMMA')}">0.00</span>
              </span>
            </div>

            <!-- Separador -->
            <hr class="separador-resumen">

            <!-- Total -->
            <div class="linea-resumen linea-total">
              <span class="label-resumen label-total">Total:</span>
              <span class="valor-resumen valor-total" id="resumen-total">
                $<span th:text="${#numbers.formatDecimal(total, 1, 'POINT', 0, 'COMMA')}">75,805.00</span>
              </span>
            </div>

            <!-- Número de pedido (si ya se generó) -->
            <div th:if="${numeroPedido != null}" class="linea-resumen linea-pedido">
              <span class="label-resumen">Número de pedido:</span>
              <span class="valor-resumen" th:text="${numeroPedido}">6534</span>
            </div>
          </div>

          <!-- Botón Continuar Compra (Checkout) -->
          <button class="btn btn-primary btn-mimo btn-checkout" onclick="procesarCheckout()">
            Continuar compra
          </button>
        </div>

      </div>
    </div>

    <!-- FOOTER -->
    <footer>
      <div class="footer-links">
        <a href="#">Convenios</a>
        <a href="#">Encuéntranos</a>
        <a href="#">Trabaja con nosotros</a>
        <a href="#">Contacto</a>
        <a href="#">Políticas</a>
      </div>
    </footer>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JS AJAX para operaciones del carrito (NIVEL 2 - Mínimo ~60 líneas) -->
  <script>
    // Cambiar cantidad (+ o -)
    function cambiarCantidad(idProducto, delta) {
      const inputCantidad = document.getElementById('cantidad-' + idProducto);
      const cantidadActual = parseInt(inputCantidad.value);
      const nuevaCantidad = cantidadActual + delta;

      if (nuevaCantidad < 1) {
        return; // No permitir cantidad menor a 1
      }

      // Llamada AJAX al backend
      fetch('/api/carrito/actualizar', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          idProducto: idProducto,
          cantidad: nuevaCantidad
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar UI sin recargar
          actualizarCarritoUI(data);
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar cantidad');
      });
    }

    // Eliminar item del carrito
    function eliminarItem(idProducto) {
      if (!confirm('¿Estás seguro de eliminar este producto del carrito?')) {
        return;
      }

      fetch('/api/carrito/eliminar/' + idProducto, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remover tarjeta del DOM
          const itemCard = document.getElementById('item-' + idProducto);
          itemCard.style.transition = 'opacity 0.3s';
          itemCard.style.opacity = '0';
          setTimeout(() => {
            itemCard.remove();
            // Si no quedan items, recargar página para mostrar "carrito vacío"
            if (document.querySelectorAll('.item-card').length === 0) {
              location.reload();
            } else {
              actualizarCarritoUI(data);
            }
          }, 300);
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar producto');
      });
    }

    // Vaciar carrito completo
    function vaciarCarrito() {
      if (!confirm('¿Estás seguro de vaciar todo el carrito?')) {
        return;
      }

      fetch('/api/carrito/vaciar', {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload(); // Recargar para mostrar "carrito vacío"
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al vaciar carrito');
      });
    }

    // Procesar checkout (verifica datos de envío y redirige)
    function procesarCheckout() {
      // Deshabilitar botón para evitar múltiples clicks
      const btnCheckout = document.querySelector('.btn-checkout');
      const textoOriginal = btnCheckout.textContent;
      btnCheckout.disabled = true;
      btnCheckout.textContent = 'Procesando...';

      fetch('/api/carrito/checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin' // Asegurar que se envíen las cookies de sesión
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => {
            throw new Error(err.error || 'Error al procesar checkout');
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Si tiene idPedido, ir directo a pasarela
          if (data.idPedido) {
            window.location.href = '/pasarela/' + data.idPedido;
          }
        } else if (data.requiereDatosEnvio) {
          // Si necesita completar datos de envío, redirigir
          alert('Por favor completa tus datos de envío antes de continuar');
          window.location.href = '/datos-envio';
        } else {
          // Restaurar botón si hay error
          btnCheckout.disabled = false;
          btnCheckout.textContent = textoOriginal;
          alert('Error: ' + (data.mensaje || data.error || 'Error desconocido'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // Restaurar botón
        btnCheckout.disabled = false;
        btnCheckout.textContent = textoOriginal;
        alert('Error al procesar checkout: ' + error.message);
      });
    }

    // Actualizar UI del carrito sin recargar página
    function actualizarCarritoUI(data) {
      // Actualizar cantidad del item
      if (data.item) {
        const inputCantidad = document.getElementById('cantidad-' + data.item.idProducto);
        if (inputCantidad) {
          inputCantidad.value = data.item.cantidad;
        }

        // Actualizar estado del botón decrementar (habilitar/deshabilitar)
        const btnDecrementar = document.querySelector(`button[data-producto-id="${data.item.idProducto}"].btn-decrementar`);
        if (btnDecrementar) {
          btnDecrementar.disabled = data.item.cantidad <= 1;
        }

        // Actualizar subtotal del item
        const subtotalElement = document.getElementById('subtotal-' + data.item.idProducto);
        if (subtotalElement) {
          subtotalElement.querySelector('span').textContent =
            '$' + formatearNumero(data.item.subtotal);
        }
      }

      // Actualizar resumen
      if (data.resumen) {
        document.getElementById('resumen-producto').querySelector('span').textContent =
          formatearNumero(data.resumen.subtotal);
        document.getElementById('resumen-envio').querySelector('span').textContent =
          formatearNumero(data.resumen.costoEnvio);
        document.getElementById('resumen-iva').querySelector('span').textContent =
          formatearNumero(data.resumen.iva);
        document.getElementById('resumen-descuento').querySelector('span').textContent =
          formatearNumero(data.resumen.descuento);
        document.getElementById('resumen-total').querySelector('span').textContent =
          formatearNumero(data.resumen.total);
      }
    }

    // Formatear número con separadores de miles
    function formatearNumero(numero) {
      return numero.toLocaleString('es-CO', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
  </script>
</body>
</html>
